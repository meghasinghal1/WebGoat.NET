name: WebGoat Test Api
 
on:
  push:
    branches: [ master ]
    
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: Amadevus/pwsh-script@v2
      id: script
      with:
        script: |
          $sourcePath = "${{ github.workspace }}/"
          write-host "$sourcePath"
          $destinationPath = Split-Path -Path "$sourcePath"
          $destinationPath += "/${{ github.workflow }}-${{ github.run_id }}.zip"
          Write-Host "$destinationPath"
          
          if(Test-Path -Path $destinationPath -PathType Leaf)
          {
              Remove-Item $destinationPath
          }

          Add-Type -Assembly 'System.IO.Compression.FileSystem'
          $zip = [System.IO.Compression.ZipFile]::Open($destinationPath, 'create')
          $files = [IO.Directory]::GetFiles($sourcePath, "*" , [IO.SearchOption]::AllDirectories)
          foreach($file in $files)
          {
              $relPath = $file.Substring($sourcePath.Length).Replace("\\", "/").Replace("\", "/")
              $a = [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $file.Replace("\\", "/").Replace("\", "/"), $relPath);
          }
          $zip.Dispose()
    
    - uses: actions/checkout@v1
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '6.0.403'
    
    # dotnet build and publish
    - name: Build with dotnet
      run: |
        dotnet build --configuration Release ./SAST/SAST.Api/SAST.Api.csproj
